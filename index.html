<!doctype HTML>
<html>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<script src="js/aframe.min.js"></script>
<script src="js/aframe-ar.js"></script>
<script src="js/build.js">  </script>
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->

<style>
    .container {
        position: relative;
    }

    .topright {
        position: absolute;
        top: 8px;
        right: 16px;
        font-size: 18px;
        z-index: 9999;
    }

    .btn {
        background-color: DodgerBlue;
        /* Blue background */
        border: none;
        /* Remove borders */
        color: white;
        /* White text */
        padding: 12px 16px;
        /* Some padding */
        font-size: 16px;
        /* Set a font size */
        cursor: pointer;
        /* Mouse pointer on hover */
    }

    /* Darker background on mouse-over */
    .btn:hover {
        background-color: RoyalBlue;
    }

    .box {
        border: 4px solid black;
        background-color: lightgray;
        opacity: 0.8;
        width: 300px;
        height: 300px;
        overflow-y: scroll;

    }

    /*  .box:hover {
        opacity: 1;
        background-color: blue;
    }*/
</style>

<body style="margin: 0px; overflow: hidden;">
    <script>
        var areCommmentsSticky = false;
        AFRAME.registerComponent('canvas-texture', {
            init: function () {
                this.canvas = document.querySelector("#myCanvas");
                this.canvas.width = 512;
                this.canvas.height = 512;
                this.context = this.canvas.getContext('2d');
                this.x = 200;
                this.y = 100;
                this.dx = 5;
                this.dy = 3;
                this.imgSrc = "";
                this.glNo = 0;
                this.dtsum = 0;
            },
            update: function () {
                var per32Filled = this.glNo
                let material = this.el.getObject3D("mesh").material;
                this.el.getObject3D("mesh").rotation.x = Math.PI / 2
                const chara = new Image();
                chara.src = "images/textures/texture" + this.glNo + ".jpg";
                chara.onload = () => {
                    this.context.drawImage(chara, 0, 0);
                    if (!material.map)
                        return;
                    else
                        material.map.needsUpdate = true;
                };
                document.getElementById("topLeveler").object3D.position.z = 0.508 - (1 / 32) * per32Filled;
                document.getElementById("bottomLeveler").object3D.position.z = 0.508 - (1 / 32) * per32Filled;
                document.getElementById("floatingText").object3D.position.z = 0.45 - (1 / 32) * per32Filled;
                document.getElementById("floatingText").setAttribute("text", "value", "Peso: " + per32Filled * 674 + "kg");
                //console.log(document.getElementById("floatingText").object3D.position.z)
            },
            tick: function (t, dt) {
                this.dtsum += dt;
                if (this.dtsum >= 100) {
                    this.dtsum = 0;
                    if (this.glNo >= 32) {
                        this.glNo = 0;
                    } else {
                        this.glNo += 1;
                    }
                    this.update();
                }
            }
        });
        AFRAME.registerComponent('commentbox', {
            schema: {
                'target': { type: 'selector' },
            },
            init: function () {
                console.log("commentBox init");
                this.dtsum = 0;
                this.el.addEventListener('mouseenter', (ev, target) => {
                    const intersectedElement = ev && ev.detail && ev.detail.intersectedEl;
                    if (this.el && intersectedElement === this.el) {
                        const objectId = this.el.id;
                        console.log(`click event on ${objectId} fired`);
                        window.location.href = './event_page.html';
                    }
                })
            },
            update: function () {
                var div1 = document.createElement("div");
                div1.setAttribute("class", "box");
                console.log("commentBox update");

                fetch("https://6373fcb9716c2e1916557b6d.mockapi.io/messages").then((response) => {
                    return response.json();
                }).then((data) => {
                    data.forEach((message) => {
                        var div2 = document.createElement("div");
                        div2.style.borderBottom = "1px dashed black";
                        div2.setAttribute("class", "message");
                        div2.innerHTML = "<h3>" + message.title + "</h3><p>" + message.message + "</p>";
                        div1.appendChild(div2);
                        var staticDiv = document.getElementById("staticComments")
                        staticDiv.appendChild(div1);
                        staticDiv.innerHTML = div1.innerHTML;
                        staticDiv.setAttribute("class", "box");
                    });
                    //getFirstElementOf this.el
                    this.el.innerHTML = "";
                    this.el.appendChild(div1);
                });
                if (div1.childElementCount == 0) {
                    var div2 = document.createElement("div");
                    div2.innerHTML = "<h3>Não existem Comentários</h3>";
                }

            },

            tick: function (t, dt) {
                this.dtsum += dt;
                if (this.dtsum >= 10000) {
                    this.dtsum = 0;
                    this.update();
                }
                this.el.setAttribute("visible", !areCommmentsSticky);
            }
        });

        /*AFRAME.registerComponent('markerhandler', {

            init: function () {
                const animatedMarker = document.querySelector("#animated-marker");
                const aEntity = document.querySelector("#aaa");
                console.log(aEntity);
                // every click, we make our model grow in size :)
                animatedMarker.addEventListener('click', function (ev, target) {
                    const intersectedElement = ev && ev.detail && ev.detail.intersectedEl;
                    if (aEntity && intersectedElement === aEntity) {
                        console.log("a")
                    }
                });
            }
        });*/
        function toggleStickyComments() {
            document.getElementById("staticComments").style.display = areCommmentsSticky ? "none" : "block";
            areCommmentsSticky = !areCommmentsSticky;
        }

    </script>

    <a-scene embedded vr-mode-ui="enabled: false;" arjs="debugUIEnabled: false;">
        <a-assets>
            <canvas id="myCanvas"></canvas>
        </a-assets>
        <a-marker markerhandler emitevents="true" cursor="rayOrigin: mouse" raycaster="objects: .clickable"
            id="animated-marker" type="pattern" url="data/hiro.patt">

            <a-cylinder id="aaa" position="0 0.5 0" radius="0.5"
                material="src: #myCanvas; transparent: true; opacity: 0.25;" canvas-texture>
            </a-cylinder>
            <a-cone rotation="90 0 0" position="0 0.5 0.75" radius="0.5" scale="0.5 0.5 0.5" material="opacity: 0.95;">
            </a-cone>
            <a-circle position="0 0.5 0.508" radius="0.5"></a-circle>
            <a-circle rotation="0 180 0" position="0 0.5 -0.508" radius="0.5"></a-circle>
            <!-- PERNAS -->
            <a-box position="0.4 0.9 1" radius="0.5" scale="0.125 0.125 1"></a-box>
            <a-box position="-0.4 0.9 1" radius="0.5" scale="0.125 0.125 1"></a-box>
            <a-box position="0.4 0.2 1" radius="0.5" scale="0.125 0.125 1"></a-box>
            <a-box position="-0.4 0.2 1" radius="0.5" scale="0.125 0.125 1"></a-box>

            <a-circle radius="0.6" color="brown" id="topLeveler" position="0 0.5 0.508"></a-circle>
            <a-circle radius="0.6" color="brown" id="bottomLeveler" rotation="0 180 0" position="0 0.5 0.508">
            </a-circle>

            <!-- BASE -->
            <a-box rotation="0 0 90" position="0 0.57 0.56" radius="0.5" scale="0.8 0.93 0.125"></a-box>

            <a-entity id="arComment" htmlembed="ppu:256" class="screen" commentbox scale="1 1 1" position="1.2 0.5 -0.7"
                rotation="270 0 0">
            </a-entity>
            <a-text id="floatingText" color="black" scale="0.4 0.4 0.4" position="0 1.2 1" text="value:Peso: 30kg"
                rotation="270 0 0">
            </a-text>


        </a-marker>
        <a-entity camera>
            <!-- <a-cursor></a-cursor> -->
        </a-entity>


    </a-scene>
    <div class="topright">
        <button class="btn" onclick="toggleStickyComments()">Afixar</button>
        <div style="display: none;" id="staticComments">

        </div>
    </div>

</body>
<script>

</script>

</html>