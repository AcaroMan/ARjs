<!DOCTYPE html>

<head>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<title>Hello, AR Cube!</title>
	<!-- include three.js library -->
	<script src="https://r105.threejsfundamentals.org/threejs/resources/threejs/r105/three.min.js"></script>
	<script src="https://r105.threejsfundamentals.org/threejs/resources/threejs/r105/js/loaders/GLTFLoader.js"></script>
	<script src="//cdn.rawgit.com/mrdoob/three.js/master/examples/js/renderers/CSS3DRenderer.js"></script>
	<script src="jsartoolkit5/artoolkit.min.js"></script>
	<script src="jsartoolkit5/artoolkit.api.js"></script>
	<!-- include threex.artoolkit -->
	<script src="threex/threex-artoolkitsource.js"></script>
	<script src="threex/threex-artoolkitcontext.js"></script>
	<script src="threex/threex-arbasecontrols.js"></script>
	<script src="threex/threex-armarkercontrols.js"></script>
</head>

<body style='margin : 0px; overflow: hidden; font-family: Monospace;'>

	<!-- 
  Example created by Lee Stemkoski: https://github.com/stemkoski
  Based on the AR.js library and examples created by Jerome Etienne: https://github.com/jeromeetienne/AR.js/
-->

	<script>

		var scene, camera, renderer, cssRenderer, clock, deltaTime, totalTime;

		var arToolkitSource, arToolkitContext;

		var markerRoot1, markerRoot2;

		var mesh1;

		initialize();
		animate();
		function Element(y, x, z, ry) {

			const div = document.createElement('div');
			div.style.width = '480px';
			div.style.height = '360px';
			div.style.backgroundColor = '#000';

			const h1 = document.createElement('h1');
			h1.style.width = '480px';
			h1.style.height = '360px';
			h1.style.border = '0px';
			h1.style.backgroundColor = '#ddd';
			h1.textContent = 'This is my custom text';
			div.appendChild(h1);

			const object = new THREE.CSS3DObject(div);
			object.scale.set(0.5, 0.5, 0.5)

			object.position.set(x, y, z);
			//object.rotation.y = ry;

			return object;

		}

		function initialize() {
			const container = document.getElementById('container');
			scene = new THREE.Scene();
			const loader = new THREE.GLTFLoader();
			let ambientLight = new THREE.AmbientLight(0xcccccc, 0.5);
			scene.add(ambientLight);
			cssRenderer = new THREE.CSS3DRenderer();
			cssRenderer.setSize(640, 480);
			camera = new THREE.Camera();
			scene.add(camera);

			renderer = new THREE.WebGLRenderer({
				antialias: true,
				alpha: true
			});

			renderer.setClearColor(new THREE.Color('lightgrey'), 0)
			renderer.setSize(640, 480);
			renderer.domElement.style.position = 'absolute'
			renderer.domElement.style.top = '0px'
			renderer.domElement.style.left = '0px'
			document.body.appendChild(renderer.domElement);
			document.body.appendChild(cssRenderer.domElement);
			clock = new THREE.Clock();
			deltaTime = 0;
			totalTime = 0;

			////////////////////////////////////////////////////////////
			// setup arToolkitSource
			////////////////////////////////////////////////////////////

			arToolkitSource = new THREEx.ArToolkitSource({
				sourceType: 'webcam',
			});

			function onResize() {
				arToolkitSource.onResize()
				arToolkitSource.copySizeTo(renderer.domElement)
				if (arToolkitContext.arController !== null) {
					arToolkitSource.copySizeTo(arToolkitContext.arController.canvas)
				}
			}

			arToolkitSource.init(function onReady() {
				onResize()
			});

			// handle resize event
			window.addEventListener('resize', function () {
				onResize()
			});

			////////////////////////////////////////////////////////////
			// setup arToolkitContext
			////////////////////////////////////////////////////////////	

			// create atToolkitContext
			arToolkitContext = new THREEx.ArToolkitContext({
				cameraParametersUrl: 'data/camera_para.dat',
				detectionMode: 'mono'
			});

			// copy projection matrix to camera when initialization complete
			arToolkitContext.init(function onCompleted() {
				camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
			});

			////////////////////////////////////////////////////////////
			// setup markerRoots
			////////////////////////////////////////////////////////////

			// build markerControls
			markerRoot1 = new THREE.Group();
			markerRoot1.add(new Element(0, 0, 0, Math.PI))

			scene.add(markerRoot1);
			let markerControls1 = new THREEx.ArMarkerControls(arToolkitContext, markerRoot1, {
				type: 'pattern', patternUrl: "data/hiro.patt",
			})

			let geometry1;
			console.log("Testing 5");
			loader.load("./public/Water.gltf", (gltf) => {
				geometry1 = gltf.scene.children[0]
				geometry1.scale.set(0.005, 0.005, 0.005)
				//geometry1.position.y = -80;
				//geometry1.position.x = -20;
				//geometry1.position.z = 0;
				let count = 0
				setInterval(() => {
					const texture = new THREE.TextureLoader().load("./images/textures/texture" + count + ".jpg");
					// texture.wrapS = THREE.RepeatWrapping;
					texture.wrapT = THREE.RepeatWrapping;
					texture.repeat.set(1, 2);
					setTimeout(() => {
						geometry1.material = new THREE.MeshBasicMaterial({ map: texture });
					}, 75);
					count += 1
					count == 32 ? count = 0 : count
				}, 100)
				//geometry1.rotation.y = 0.5;
				markerRoot1.add(geometry1);
				geometry1.position.set(0, 1.25 / 2, 0)

			});


			/*let material1 = new THREE.MeshNormalMaterial({
				transparent: true,
				opacity: 0.5,
				side: THREE.DoubleSide
			});*/

			//mesh1 = new THREE.Mesh(geometry1, material1);
			//mesh1.position.y = 0.5;
			//markerRoot1.add(mesh1);
		}


		function update() {
			// update artoolkit on every frame
			if (arToolkitSource.ready !== false)
				arToolkitContext.update(arToolkitSource.domElement);
		}


		function render() {
			renderer.render(scene, camera);
			cssRenderer.render(scene, camera);

		}


		function animate() {
			requestAnimationFrame(animate);
			deltaTime = clock.getDelta();
			totalTime += deltaTime;
			update();
			render();
		}

	</script>

</body>

</html>